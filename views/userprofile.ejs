<!--
I declare that this code was written by me.
I will not copy or allow others to copy my code.
I understand that copying code is considered as plagiarism.

Student Name: Marla
Student ID: 24014514
Class: E63C c004
Date created: January 16, 2026
-->

<!--
I declare that this code was written by me.
I will not copy or allow others to copy my code.
I understand that copying code is considered as plagiarism.

Student Name: Raphaela Lee
Student ID: 24009059
Class: c004
Date created: February 5, 2026
-->

<%- include('partials/navbar-user') %>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Fraunces:wght@600;700;800&family=Manrope:wght@400;600;700&display=swap');
  body { background:#f6efe6; color:#2a241e; font-family: "Manrope", "Segoe UI", Arial, sans-serif; }
  .profile-wrap { max-width:980px; margin:34px auto 60px; padding:0 22px; }

  .page-head { display:flex; align-items:flex-start; justify-content:space-between; gap:16px; margin-bottom:18px; }
  .page-title { font-family: "Fraunces", "Times New Roman", serif; font-size:26px; font-weight:800; margin:0; color:#2a241e; }
  .page-sub { margin-top:6px; color:#6f6256; font-size:14px; line-height:1.4; }
  .back-link { display:inline-flex; align-items:center; gap:8px; text-decoration:none; color:#2a241e; font-weight:600; border:1px solid #eadac6; background:#fffaf3; padding:10px 14px; border-radius:999px; box-shadow:0 10px 24px rgba(42,36,30,0.08); transition:0.15s ease; }
  .back-link:hover { transform: translateY(-1px); background:#fff; }
  .page-actions { display:flex; gap:10px; align-items:center; }
  .logout-link { background:#fff3f3; border-color:#f0c1c1; color:#8f1d1d; }
  .logout-link:hover { background:#ffe8e8; }

  .card { background:#fffaf3; border:1px solid #eadac6; border-radius:22px; box-shadow:0 14px 34px rgba(42,36,30,0.10); padding:26px; margin-bottom:30px; }

  .profile-header { display:flex; align-items:center; gap:20px; margin-bottom:20px; }
  .profile-avatar { position: relative; width:100px; height:100px; border-radius:50%; overflow:hidden; border:2px solid #dd9b00; }
  .profile-avatar img { width:100%; height:100%; object-fit:cover; }
  .profile-avatar input[type="file"] { position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer; }

  .profile-info h2 { margin:0; font-size:20px; font-family: "Fraunces", "Times New Roman", serif; }
  .profile-info p { margin:4px 0; font-size:14px; color:#6f6256; }

  .profile-header { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; position: relative; }
  .wallet-btn { margin-left: auto; display:flex; flex-direction:column; gap:10px; align-items:flex-end; }
  .wallet-btn .btn { padding: 8px 16px; font-size: 14px; text-decoration: none; }

  /* Tabs */
  .tabs { display:flex; gap:10px; border-bottom:1px solid #ddd; margin-bottom:20px; }
  .tab { padding:10px 20px; cursor:pointer; font-weight:600; border-radius:20px 20px 0 0; background:#fdf7ec; color:#2a241e; font-family: "Fraunces", "Times New Roman", serif; }
  .tab.active { background:#dd9b00; color:white; }

  /* Orders Table */
  table { width:100%; border-collapse:collapse; margin-top:15px; }
  th, td { padding:12px 8px; text-align:left; font-size:14px; }
  th { background:#fdeeda; color:#2a241e; }
  tbody tr { background:#fffaf3; border-bottom:1px solid #eadac6; }
  tbody tr:last-child { border-bottom:none; }

  .grid { display:grid; grid-template-columns: 1fr 1fr; gap:18px; margin-top:10px; }
  .field { display:flex; flex-direction:column; gap:8px; }
  label { font-weight:700; font-size:13px; color:#2a241e; }
  input[type=text], input[type=email], input[type=password] { background:#fff; border:1px solid #eadac6; border-radius:14px; padding:12px 14px; font-size:14px; outline:none; transition:0.15s ease; }
  input[type=text]:focus, input[type=email]:focus, input[type=password]:focus { border-color: rgba(213,155,45,0.7); box-shadow:0 0 0 4px rgba(213,155,45,0.16); }
  .password-field { position: relative; }
  .password-field input { padding-right: 44px; }
  .toggle-visibility { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); border: none; background: transparent; color:#9a7b37; padding:4px; cursor:pointer; font-size:18px; }
  .toggle-visibility:focus { outline: none; }
  .password-hint { margin:6px 0 0; font-size:12px; color:#6f6256; }

  .actions { margin-top:18px; display:flex; justify-content:flex-end; gap:12px; flex-wrap:wrap; }
  .btn { border:none; border-radius:999px; padding:11px 18px; font-weight:700; cursor:pointer; font-size:14px; transition:0.15s ease; }
  .btn-primary { background:#d59b2d; color:#fff; box-shadow:0 10px 24px rgba(213,155,45,0.22); }
  .btn-primary:hover { background:#b97d18; transform:translateY(-1px); }

  /* Flash messages */
  .alert { padding:12px 18px; border-radius:12px; margin-bottom:20px; font-weight:600; }
  .alert-success { background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
  .alert-danger { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }

  /* Points tab enhancements */
  .points-head { display:flex; justify-content:space-between; gap:14px; align-items:flex-start; flex-wrap:wrap; margin-bottom:12px; }
  .points-sub { color:#6f6256; font-size:13px; margin:0; max-width:720px; }
  .points-grid { display:grid; grid-template-columns:repeat(4, minmax(0,1fr)); gap:12px; margin:14px 0 16px; }
  .points-metric { background:#fff; border:1px solid #eadac6; border-radius:14px; padding:12px 14px; }
  .points-metric .label { display:block; color:#6f6256; font-size:12px; margin-bottom:4px; }
  .points-metric .value { font-size:22px; font-weight:800; color:#2a241e; line-height:1.1; }
  .points-metric .hint { font-size:12px; color:#6f6256; margin-top:5px; }
  .points-metric.earn .value { color:#1b7a2e; }
  .points-metric.redeem .value { color:#8f1d1d; }
  .points-progress-wrap { background:#fff; border:1px solid #eadac6; border-radius:14px; padding:12px 14px; margin:0 0 8px; }
  .points-progress-meta { display:flex; justify-content:space-between; gap:10px; align-items:center; font-size:12px; color:#6f6256; margin-bottom:8px; }
  .points-progress-track { width:100%; height:10px; background:#f2e3cf; border-radius:999px; overflow:hidden; }
  .points-progress-bar { height:100%; border-radius:999px; background:linear-gradient(90deg, #d59b2d 0%, #f0b83f 100%); }
  .points-value-note { margin:10px 0 0; font-size:13px; color:#2a241e; }
  .points-table-wrap { overflow-x:auto; }
  .points-type { display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700; border:1px solid transparent; }
  .points-type.earned { color:#145b23; background:#e8f5eb; border-color:#b8dfc1; }
  .points-type.redeemed { color:#7a1212; background:#fdecec; border-color:#f5c0c0; }
  .points-empty { color:#6f6256; margin:12px 0 0; }

  @media (max-width:760px){ 
    .grid{ grid-template-columns: 1fr; } 
    .page-title{ font-size:22px; } 
    .actions{ justify-content:stretch; } 
    .btn{ width:100%; } 
    .points-grid{ grid-template-columns:1fr 1fr; }
  }
</style>

<div class="profile-wrap">
  <!-- Page Header -->
  <div class="page-head">
    <div>
      <h1 class="page-title">My Profile</h1>
      <div class="page-sub">Keep your details fresh like your favorite meals! Update your info, track points, and make every HomeBitez order smooth and tasty.</div>
    </div>
    <div class="page-actions">
      <a class="back-link" href="/menu">← Back</a>
      <% if (user && user.role === 'admin') { %>
        <a class="back-link logout-link" href="/logout">Logout</a>
      <% } %>
    </div>
  </div>

  <!-- Profile Header -->
  <div class="card profile-header">
    <div class="profile-avatar">
      <img src="<%= user?.avatar || '/images/default-avatar.png' %>" alt="Profile Picture">
      <input type="file" name="avatar" onchange="previewAvatar(event)">
    </div>
    <div class="profile-info">
      <h2><%= user?.username || 'Your Name' %></h2>
      <p><%= user?.email || 'email@example.com' %></p>
      <p><i class="bi bi-telephone"></i> <%= user?.contact || 'N/A' %></p>
      <p>Points: <strong><%= user?.points || 0 %></strong></p>
    </div>
    <div class="wallet-btn">
        <a href="/digitalwallet" class="btn btn-primary">Homebitez Wallet</a>
        <a href="/paylater" class="btn btn-primary">HomeBitez PayLater</a>
    </div>
  </div>

  <!-- Flash Messages -->
  <% if (success && success.length > 0) { %>
    <div class="alert alert-success"><%= success %></div>
  <% } %>
  <% if (error && error.length > 0) { %>
    <div class="alert alert-danger"><%= error %></div>
  <% } %>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="profile">Profile</div>
    <div class="tab" data-tab="orders">Order History</div>
    <div class="tab" data-tab="messages">Messages</div>
    <div class="tab" data-tab="issues">Issues Reported</div>
    <div class="tab" data-tab="points">Points</div>
    <div class="tab" data-tab="settings">Settings</div>
  </div>

  <!-- Profile Form -->
  <div class="card tab-content" id="profile">
    <form action="/user/profile" method="POST" enctype="multipart/form-data">
      <div class="grid">
        <div class="field">
          <label>Username</label>
          <input type="text" name="username" value="<%= user?.username || '' %>" required>
        </div>
        <div class="field">
          <label>Email</label>
          <input type="email" name="email" value="<%= user?.email || '' %>" required>
        </div>
        <div class="field">
          <label>Delivery Address</label>
          <input type="text" name="address" value="<%= user?.address || '' %>">
        </div>
        <div class="field">
          <label>Contact Number</label>
          <input type="text" name="contact" value="<%= user?.contact || '' %>">
        </div>
        <div class="field">
          <label>Profile Picture</label>
          <input type="file" name="avatar" accept="image/*" onchange="previewAvatar(event)">
        </div>
      </div>
      <div class="actions">
        <button class="btn btn-primary" type="submit">Save Changes</button>
      </div>
    </form>
  </div>

  <!-- Orders Table -->
  <div class="card tab-content" id="orders" style="display:none;">
    <h3>Order History</h3>
    <table>
      <thead>
        <tr>
          <th>Order #</th>
          <th>Date</th>
          <th>Qty</th>
          <th>Total</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <% if (!orders || orders.length === 0) { %>
          <tr>
            <td colspan="6" style="text-align:center; color:#6f6256;">No orders yet.</td>
          </tr>
        <% } else { %>
          <% orders.forEach(order => { %>
            <tr>
              <td style="font-weight:700;"><%= order.orderId %></td>
              <td><%= order.date %></td>
              <td><%= order.qty %></td>
              <td>$<%= order.total.toFixed(2) %></td>
              <td><%= order.status %></td>
              <td>
                <a href="/receipt?orderId=<%= order.dbId %>" style="text-decoration:none; color:#d59b2d; font-weight:600;">
                  View receipt
                </a>
              </td>
            </tr>
          <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>
  <!-- Points Tab -->
  <div class="card tab-content" id="points" style="display:none;">
    <%
      const pointsHistory = Array.isArray(user?.pointsHistory) ? user.pointsHistory : [];
      const currentPoints = Number(user?.points || 0);
      let totalEarned = 0;
      let totalRedeemed = 0;
      pointsHistory.forEach(item => {
        const pts = Number(item?.points || 0);
        if (pts >= 0) totalEarned += pts;
        else totalRedeemed += Math.abs(pts);
      });
      const pointsValue = Number(currentPoints * 0.01).toFixed(2);
      const cycleSize = 50;
      const nextRewardAt = Math.max(cycleSize, Math.ceil((currentPoints + 1) / cycleSize) * cycleSize);
      const pointsInCycle = currentPoints % cycleSize;
      const progressPct = currentPoints === 0 ? 0 : ((pointsInCycle / cycleSize) * 100);
      const pointsToNext = Math.max(0, nextRewardAt - currentPoints);
    %>

    <div class="points-head">
      <div>
        <h3 style="margin:0 0 6px;">Your Points</h3>
        <p class="points-sub">
          Earn points every time you order on HomeBitez and redeem them for instant discounts on your next checkout.
          Every 50 points is worth about $0.50 in redemption value.
        </p>
      </div>
    </div>

    <div class="points-grid">
      <div class="points-metric">
        <span class="label">Current balance</span>
        <div class="value"><%= currentPoints %></div>
        <div class="hint">Available now</div>
      </div>
      <div class="points-metric earn">
        <span class="label">Total earned</span>
        <div class="value">+<%= totalEarned %></div>
        <div class="hint">All time</div>
      </div>
      <div class="points-metric redeem">
        <span class="label">Total redeemed</span>
        <div class="value">-<%= totalRedeemed %></div>
        <div class="hint">All time</div>
      </div>
      <div class="points-metric">
        <span class="label">Estimated value</span>
        <div class="value">$<%= pointsValue %></div>
        <div class="hint">Based on 1 point = $0.01</div>
      </div>
    </div>

    <div class="points-progress-wrap">
      <div class="points-progress-meta">
        <span>Progress to next 50-point milestone</span>
        <span>
          <% if (pointsToNext > 0) { %>
            <%= pointsToNext %> point(s) to <%= nextRewardAt %>
          <% } else { %>
            Milestone reached
          <% } %>
        </span>
      </div>
      <div class="points-progress-track">
        <div class="points-progress-bar" style="width:<%= Math.min(100, Math.max(0, progressPct)).toFixed(0) %>%;"></div>
      </div>
      <p class="points-value-note">
        Your current points can redeem up to <strong>$<%= pointsValue %></strong> at checkout.
      </p>
    </div>

    <% if (pointsHistory.length) { %>
      <div class="points-table-wrap">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Description</th>
              <th>Type</th>
              <th>Points</th>
              <th class="text-end">Balance after</th>
            </tr>
          </thead>
          <tbody>
            <% pointsHistory.forEach(item => {
              const pts = Number(item?.points || 0);
              const isRedeem = pts < 0 || String(item?.desc || '').toLowerCase().includes('redeem');
            %>
              <tr>
                <td><%= item.date %></td>
                <td><%= item.desc %></td>
                <td>
                  <span class="points-type <%= isRedeem ? 'redeemed' : 'earned' %>">
                    <%= isRedeem ? 'Redeemed' : 'Earned' %>
                  </span>
                </td>
                <td>
                  <span style="color:<%= pts >= 0 ? '#1b7a2e' : '#8f1d1d' %>; font-weight:700;">
                    <%= pts >= 0 ? '+' : '' %><%= pts %>
                  </span>
                </td>
                <td class="text-end" style="font-weight:700;"><%= item.balanceAfter %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } else { %>
      <p class="points-empty">No points transactions yet. Place your first order to start earning.</p>
    <% } %>
  </div>

  <!-- Issues Reported Tab -->
  <div class="card tab-content" id="issues" style="display:none;">
    <h3>Issues Reported</h3>
    <% if (!userIssues || userIssues.length === 0) { %>
      <p class="text-muted">No issues reported yet.</p>
    <% } else { %>
      <table>
        <thead>
          <tr>
            <th>Subject</th>
            <th>Status</th>
            <th>Created</th>
            <th>Admin Reply</th>
          </tr>
        </thead>
        <tbody>
          <% userIssues.forEach(issue => { %>
            <tr>
              <td><strong><%= issue.subject || 'No subject' %></strong></td>
              <td><%= issue.status || 'new' %></td>
              <td><%= issue.created_at ? new Date(issue.created_at).toLocaleString() : '-' %></td>
              <td><%= issue.admin_reply ? issue.admin_reply : '—' %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    <% } %>
  </div>

  <!-- Messages Tab -->
  <div class="card tab-content" id="messages" style="display:none;">
    <h3>Messages from Business Owners</h3>
    <% if (!userMessages || userMessages.length === 0) { %>
      <p class="text-muted">No messages yet.</p>
    <% } else { %>
      <table>
        <thead>
          <tr>
            <th>From</th>
            <th>Message</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody>
          <% userMessages.forEach(msg => { %>
            <tr>
              <td>
                <%= msg.senderName || 'Business Owner' %>
                <% if (msg.senderEmail) { %>
                  <span style="color:#6f6256; font-size:12px;">(<%= msg.senderEmail %>)</span>
                <% } %>
              </td>
              <td><%= msg.message %></td>
              <td><%= msg.created_at ? new Date(msg.created_at).toLocaleString() : '-' %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    <% } %>
  </div>

  <!-- Settings Tab -->
  <div class="card tab-content" id="settings" style="display:none;">
    <h3>Account Settings</h3>

    <!-- Change Password -->
    <form action="/user/change-password" method="POST">
        <h5>Change Password</h5>
        <div class="grid">
          <div class="field" style="grid-column:1 / -1;">
              <label>Current Password</label>
              <div class="password-field">
                <input id="currentPassword" type="password" name="currentPassword" required>
                <button class="toggle-visibility" type="button" data-target="currentPassword" aria-label="Show password">
                  <i class="bi bi-eye-slash"></i>
                </button>
              </div>
          </div>
          <div class="field">
              <label>New Password</label>
              <div class="password-field">
                <input id="newPassword" type="password" name="newPassword" required
                       pattern="^(?=.*[A-Z])(?=.*[^A-Za-z0-9]).{8,}$"
                       title="At least 8 characters, 1 uppercase letter, and 1 special character.">
                <button class="toggle-visibility" type="button" data-target="newPassword" aria-label="Show password">
                  <i class="bi bi-eye-slash"></i>
                </button>
              </div>
              <div class="password-hint">At least 8 characters, 1 uppercase letter, and 1 special character.</div>
          </div>
          <div class="field">
              <label>Confirm New Password</label>
              <div class="password-field">
                <input id="confirmPassword" type="password" name="confirmPassword" required>
                <button class="toggle-visibility" type="button" data-target="confirmPassword" aria-label="Show password">
                  <i class="bi bi-eye-slash"></i>
                </button>
              </div>
          </div>
        </div>
        <div class="actions">
          <button class="btn btn-primary" type="submit">Update Password</button>
        </div>
    </form>

    <hr style="margin:30px 0; border-color:#eadac6;">
  </div>

</div>

<script>
  // Tab switching
  const tabs = document.querySelectorAll('.tab');
  const contents = document.querySelectorAll('.tab-content');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');

      contents.forEach(c => c.style.display = 'none');
      document.getElementById(tab.dataset.tab).style.display = 'block';
    });
  });

  // Preview profile image
  function previewAvatar(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      const profileImg = document.querySelector('.profile-header img');
      if(profileImg) profileImg.src = e.target.result;

      const navbarImg = document.getElementById('navbar-avatar');
      if(navbarImg) navbarImg.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }

  // Toggle password visibility
  document.querySelectorAll('.toggle-visibility').forEach(btn => {
    btn.addEventListener('click', () => {
      const targetId = btn.getAttribute('data-target');
      const input = document.getElementById(targetId);
      if (!input) return;
      const isHidden = input.type === 'password';
      input.type = isHidden ? 'text' : 'password';
      const icon = btn.querySelector('i');
      if (icon) {
        icon.classList.toggle('bi-eye', isHidden);
        icon.classList.toggle('bi-eye-slash', !isHidden);
      }
      btn.setAttribute('aria-label', isHidden ? 'Hide password' : 'Show password');
    });
  });

  // Simple confirm password match hint
  const newPasswordInput = document.getElementById('newPassword');
  const confirmPasswordInput = document.getElementById('confirmPassword');
  if (newPasswordInput && confirmPasswordInput) {
    const validateMatch = () => {
      if (confirmPasswordInput.value && confirmPasswordInput.value !== newPasswordInput.value) {
        confirmPasswordInput.setCustomValidity('Passwords do not match.');
      } else {
        confirmPasswordInput.setCustomValidity('');
      }
    };
    newPasswordInput.addEventListener('input', validateMatch);
    confirmPasswordInput.addEventListener('input', validateMatch);
  }
</script>

<%- include('partials/foot') %>


