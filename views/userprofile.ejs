<%- include('partials/navbar-user') %>

<style>
  body { background:#f6efe6; color:#2a241e; font-family: Arial, sans-serif; }
  .profile-wrap { max-width:980px; margin:34px auto 60px; padding:0 22px; }

  .page-head { display:flex; align-items:flex-start; justify-content:space-between; gap:16px; margin-bottom:18px; }
  .page-title { font-size:26px; font-weight:700; margin:0; color:#2a241e; }
  .page-sub { margin-top:6px; color:#6f6256; font-size:14px; line-height:1.4; }
  .back-link { display:inline-flex; align-items:center; gap:8px; text-decoration:none; color:#2a241e; font-weight:600; border:1px solid #eadac6; background:#fffaf3; padding:10px 14px; border-radius:999px; box-shadow:0 10px 24px rgba(42,36,30,0.08); transition:0.15s ease; }
  .back-link:hover { transform: translateY(-1px); background:#fff; }
  .page-actions { display:flex; gap:10px; align-items:center; }
  .logout-link { background:#fff3f3; border-color:#f0c1c1; color:#8f1d1d; }
  .logout-link:hover { background:#ffe8e8; }

  .card { background:#fffaf3; border:1px solid #eadac6; border-radius:22px; box-shadow:0 14px 34px rgba(42,36,30,0.10); padding:26px; margin-bottom:30px; }

  .profile-header { display:flex; align-items:center; gap:20px; margin-bottom:20px; }
  .profile-avatar { position: relative; width:100px; height:100px; border-radius:50%; overflow:hidden; border:2px solid #dd9b00; }
  .profile-avatar img { width:100%; height:100%; object-fit:cover; }
  .profile-avatar input[type="file"] { position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer; }

  .profile-info h2 { margin:0; font-size:20px; }
  .profile-info p { margin:4px 0; font-size:14px; color:#6f6256; }

  .profile-header { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; position: relative; }
  .wallet-btn { margin-left: auto; display:flex; flex-direction:column; gap:10px; align-items:flex-end; }
  .wallet-btn .btn { padding: 10px 22px; font-size: 16px; text-decoration: none; }

  /* Tabs */
  .tabs { display:flex; gap:10px; border-bottom:1px solid #ddd; margin-bottom:20px; }
  .tab { padding:10px 20px; cursor:pointer; font-weight:600; border-radius:20px 20px 0 0; background:#fdf7ec; color:#2a241e; }
  .tab.active { background:#dd9b00; color:white; }

  /* Orders Table */
  table { width:100%; border-collapse:collapse; margin-top:15px; }
  th, td { padding:12px 8px; text-align:left; font-size:14px; }
  th { background:#fdeeda; color:#2a241e; }
  tbody tr { background:#fffaf3; border-bottom:1px solid #eadac6; }
  tbody tr:last-child { border-bottom:none; }

  .grid { display:grid; grid-template-columns: 1fr 1fr; gap:18px; margin-top:10px; }
  .field { display:flex; flex-direction:column; gap:8px; }
  label { font-weight:700; font-size:13px; color:#2a241e; }
  input[type=text], input[type=email], input[type=password] { background:#fff; border:1px solid #eadac6; border-radius:14px; padding:12px 14px; font-size:14px; outline:none; transition:0.15s ease; }
  input[type=text]:focus, input[type=email]:focus, input[type=password]:focus { border-color: rgba(213,155,45,0.7); box-shadow:0 0 0 4px rgba(213,155,45,0.16); }

  .actions { margin-top:18px; display:flex; justify-content:flex-end; gap:12px; flex-wrap:wrap; }
  .btn { border:none; border-radius:999px; padding:11px 18px; font-weight:700; cursor:pointer; font-size:14px; transition:0.15s ease; }
  .btn-primary { background:#d59b2d; color:#fff; box-shadow:0 10px 24px rgba(213,155,45,0.22); }
  .btn-primary:hover { background:#b97d18; transform:translateY(-1px); }

  /* Flash messages */
  .alert { padding:12px 18px; border-radius:12px; margin-bottom:20px; font-weight:600; }
  .alert-success { background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
  .alert-danger { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }

  @media (max-width:760px){ 
    .grid{ grid-template-columns: 1fr; } 
    .page-title{ font-size:22px; } 
    .actions{ justify-content:stretch; } 
    .btn{ width:100%; } 
  }
</style>

<div class="profile-wrap">
  <!-- Page Header -->
  <div class="page-head">
    <div>
      <h1 class="page-title">My Profile</h1>
      <div class="page-sub">Update your personal details to make ordering faster and smoother.</div>
    </div>
    <div class="page-actions">
      <a class="back-link" href="/menu">‚Üê Back</a>
      <% if (user && user.role === 'admin') { %>
        <a class="back-link logout-link" href="/logout">Logout</a>
      <% } %>
    </div>
  </div>

  <!-- Profile Header -->
  <div class="card profile-header">
    <div class="profile-avatar">
      <img src="<%= user?.avatar || '/images/default-avatar.png' %>" alt="Profile Picture">
      <input type="file" name="avatar" onchange="previewAvatar(event)">
    </div>
    <div class="profile-info">
      <h2><%= user?.username || 'Your Name' %></h2>
      <p><%= user?.email || 'email@example.com' %></p>
      <p><i class="bi bi-telephone"></i> <%= user?.contact || 'N/A' %></p>
      <p>Points: <strong><%= user?.points || 0 %></strong></p>
    </div>
    <div class="wallet-btn">
        <a href="/digitalwallet" class="btn btn-primary">Homebitez Wallet</a>
        <a href="/paylater" class="btn btn-primary">HomeBitez PayLater</a>
    </div>
  </div>

  <!-- Flash Messages -->
  <% if (success && success.length > 0) { %>
    <div class="alert alert-success"><%= success %></div>
  <% } %>
  <% if (error && error.length > 0) { %>
    <div class="alert alert-danger"><%= error %></div>
  <% } %>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="profile">Profile</div>
    <div class="tab" data-tab="orders">Order History</div>
    <div class="tab" data-tab="points">Points</div>
    <div class="tab" data-tab="settings">Settings</div>
  </div>

  <!-- Profile Form -->
  <div class="card tab-content" id="profile">
    <form action="/user/profile" method="POST" enctype="multipart/form-data">
      <div class="grid">
        <div class="field">
          <label>Username</label>
          <input type="text" name="username" value="<%= user?.username || '' %>" required>
        </div>
        <div class="field">
          <label>Email</label>
          <input type="email" name="email" value="<%= user?.email || '' %>" required>
        </div>
        <div class="field">
          <label>Delivery Address</label>
          <input type="text" name="address" value="<%= user?.address || '' %>">
        </div>
        <div class="field">
          <label>Contact Number</label>
          <input type="text" name="contact" value="<%= user?.contact || '' %>">
        </div>
        <div class="field">
          <label>Profile Picture</label>
          <input type="file" name="avatar" accept="image/*" onchange="previewAvatar(event)">
        </div>
      </div>
      <div class="actions">
        <button class="btn btn-primary" type="submit">Save Changes</button>
      </div>
    </form>
  </div>

  <!-- Orders Table -->
  <div class="card tab-content" id="orders" style="display:none;">
    <h3>Order History</h3>
    <table>
      <thead>
        <tr>
          <th>Order #</th>
          <th>Date</th>
          <th>Qty</th>
          <th>Total</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <% if (!orders || orders.length === 0) { %>
          <tr>
            <td colspan="6" style="text-align:center; color:#6f6256;">No orders yet.</td>
          </tr>
        <% } else { %>
          <% orders.forEach(order => { %>
            <tr>
              <td style="font-weight:700;"><%= order.orderId %></td>
              <td><%= order.date %></td>
              <td><%= order.qty %></td>
              <td>$<%= order.total.toFixed(2) %></td>
              <td><%= order.status %></td>
              <td><a href="/receipt" style="text-decoration:none; color:#d59b2d; font-weight:600;">View receipt</a></td>
            </tr>
          <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>

  <!-- Points Tab -->
  <div class="card tab-content" id="points" style="display:none;">
    <h3>Your Points</h3>
    <p>You currently have <strong><%= user?.points || 0 %></strong> points.</p>
    <% if (user?.pointsHistory?.length) { %>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Description</th>
            <th>Points</th>
          </tr>
        </thead>
        <tbody>
          <% user.pointsHistory.forEach(item => { %>
            <tr>
              <td><%= item.date %></td>
              <td><%= item.desc %></td>
              <td><%= item.points %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    <% } else { %>
      <p>No points transactions yet.</p>
    <% } %>
  </div>

  <!-- Settings Tab -->
  <div class="card tab-content" id="settings" style="display:none;">
    <h3>Account Settings</h3>

    <!-- Change Password -->
    <form action="/user/change-password" method="POST">
        <h5>Change Password</h5>
        <div class="grid">
          <div class="field">
              <label>Current Password</label>
              <input type="password" name="currentPassword" required>
          </div>
          <div class="field">
              <label>New Password</label>
              <input type="password" name="newPassword" required>
          </div>
          <div class="field">
              <label>Confirm New Password</label>
              <input type="password" name="confirmPassword" required>
          </div>
        </div>
        <div class="actions">
          <button class="btn btn-primary" type="submit">Update Password</button>
        </div>
    </form>

    <hr style="margin:30px 0; border-color:#eadac6;">
  </div>

</div>

<script>
  // Tab switching
  const tabs = document.querySelectorAll('.tab');
  const contents = document.querySelectorAll('.tab-content');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');

      contents.forEach(c => c.style.display = 'none');
      document.getElementById(tab.dataset.tab).style.display = 'block';
    });
  });

  // Preview profile image
  function previewAvatar(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      const profileImg = document.querySelector('.profile-header img');
      if(profileImg) profileImg.src = e.target.result;

      const navbarImg = document.getElementById('navbar-avatar');
      if(navbarImg) navbarImg.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }
</script>

<%- include('partials/foot') %>





