<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HomeBitez - Manage Customers</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sniglet:wght@700;900&family=Sora:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --cream: #fff5ea;
      --card: #fffaf3;
      --ink: #2a241e;
      --muted: #6f6256;
      --line: #eadac6;
      --accent: #d59b2d;
      --accent-strong: #b97d18;
      --danger: #c92a2a;
      --danger-bg: #ffe8e8;
      --success: #2f9e44;
      --success-bg: #e9f7ed;
      --shadow: 0 12px 28px rgba(42, 36, 30, 0.10);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Sora", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(1200px 600px at 10% -10%, #fff1de 0%, transparent 60%),
        linear-gradient(180deg, var(--cream) 0%, #fff8f0 100%);
      min-height: 100vh;
    }

    .page {
      max-width: 1220px;
      margin: 28px auto 84px;
      padding: 0 24px;
      display: grid;
      gap: 14px;
    }

    .head {
      display: flex;
      justify-content: space-between;
      align-items: end;
      gap: 12px;
      flex-wrap: wrap;
    }

    .title {
      margin: 0;
      font-size: 28px;
      line-height: 1.1;
      font-weight: 800;
      letter-spacing: -0.02em;
    }

    .subtle {
      color: var(--muted);
      font-size: 13px;
      margin-top: 6px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
    }

    .stat {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 14px;
    }

    .stat-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 800;
      line-height: 1;
    }

    .toolbar {
      display: grid;
      grid-template-columns: minmax(260px, 1fr) 200px 190px;
      gap: 10px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 12px;
    }

    .field {
      display: flex;
      align-items: center;
      gap: 8px;
      min-height: 42px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      padding: 8px 10px;
    }

    .field label {
      color: var(--muted);
      font-size: 12px;
      font-weight: 700;
      white-space: nowrap;
    }

    .field input,
    .field select {
      border: none;
      outline: none;
      width: 100%;
      font-size: 13px;
      color: var(--ink);
      background: transparent;
      font-family: inherit;
    }

    .alert {
      border-radius: 10px;
      border: 1px solid transparent;
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 600;
    }

    .alert.success {
      background: var(--success-bg);
      color: #1d6f31;
      border-color: #b8dfc1;
    }

    .alert.error {
      background: var(--danger-bg);
      color: #982222;
      border-color: #f2bfc0;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .card-top {
      border-bottom: 1px solid var(--line);
      padding: 12px 14px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      color: var(--muted);
      font-size: 12px;
      background: #fffdf9;
    }

    .table-wrap {
      overflow: auto;
      max-height: 68vh;
    }

    table {
      width: 100%;
      min-width: 980px;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 13px;
    }

    thead th {
      position: sticky;
      top: 0;
      z-index: 2;
      background: #fff5e8;
      color: #4f4337;
      text-align: left;
      font-weight: 700;
      padding: 11px 12px;
      border-bottom: 1px solid var(--line);
      white-space: nowrap;
    }

    tbody td {
      padding: 11px 12px;
      border-bottom: 1px solid var(--line);
      vertical-align: top;
      background: #fff;
    }

    tbody tr:nth-child(even) td {
      background: #fffdf9;
    }

    tbody tr:hover td {
      background: #fff5e8;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .avatar {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 800;
      color: #6b4b0f;
      background: #fff2d8;
      border: 1px solid #f2d8a7;
      text-transform: uppercase;
    }

    .id-chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 50px;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 800;
      color: #6a4b14;
      background: #fff2d8;
      border: 1px solid #f2d8a7;
    }

    .name {
      font-weight: 700;
      color: var(--ink);
      margin-bottom: 3px;
    }

    .email {
      color: var(--muted);
      font-size: 12px;
      word-break: break-word;
      max-width: 260px;
    }

    .points-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 800;
      border: 1px solid transparent;
      min-width: 54px;
    }

    .points-pill.high {
      color: #145b23;
      background: #e8f5eb;
      border-color: #b8dfc1;
    }

    .points-pill.mid {
      color: #7a5a00;
      background: #fff6db;
      border-color: #f3dfaa;
    }

    .points-pill.zero {
      color: #6f6256;
      background: #f6f0e9;
      border-color: #e6d8c9;
    }

    .terminate-btn {
      border: none;
      background: #ff6b6b;
      color: #fff;
      border-radius: 9px;
      padding: 8px 12px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .terminate-btn:hover {
      background: #f35a5a;
    }

    .terminate-btn span {
      width: 18px;
      height: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.22);
      font-weight: 800;
    }

    .empty {
      text-align: center;
      padding: 28px 0 34px;
      color: var(--muted);
      font-weight: 600;
      background: #fff;
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 1050px) {
      .stats {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .toolbar {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 720px) {
      .page {
        padding: 0 14px;
      }

      .stats {
        grid-template-columns: 1fr;
      }

      .title {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <%- include('partials/navbar-admin') %>

  <%
    const safeCustomers = Array.isArray(customers) ? customers : [];
    const totalPoints = safeCustomers.reduce((sum, c) => sum + Number(c?.points || 0), 0);
    const activePoints = safeCustomers.filter(c => Number(c?.points || 0) > 0).length;
    const topHolder = safeCustomers.reduce((max, c) => {
      const p = Number(c?.points || 0);
      return p > Number(max?.points || 0) ? c : max;
    }, null);
  %>

  <main class="page">
    <section class="head">
      <div>
        <h1 class="title">Manage Customers</h1>
        <div class="subtle">Track customer details, points, and quickly find accounts.</div>
      </div>
    </section>

    <% if (success && success.length) { %>
      <div class="alert success"><%= success[0] %></div>
    <% } %>
    <% if (error && error.length) { %>
      <div class="alert error"><%= error[0] %></div>
    <% } %>

    <section class="stats">
      <article class="stat">
        <div class="stat-label">Total Customers</div>
        <div class="stat-value"><%= safeCustomers.length %></div>
      </article>
      <article class="stat">
        <div class="stat-label">Total Points</div>
        <div class="stat-value"><%= totalPoints %></div>
      </article>
      <article class="stat">
        <div class="stat-label">With Points</div>
        <div class="stat-value"><%= activePoints %></div>
      </article>
      <article class="stat">
        <div class="stat-label">Top Holder</div>
        <div class="stat-value" style="font-size:18px;"><%= topHolder?.username || '-' %></div>
      </article>
    </section>

    <section class="toolbar">
      <div class="field">
        <label for="customerSearch">Search</label>
        <input id="customerSearch" type="search" placeholder="ID, name, email or number" />
      </div>

      <div class="field">
        <label for="pointsFilter">Points</label>
        <select id="pointsFilter">
          <option value="all">All</option>
          <option value="high">50 and above</option>
          <option value="mid">1 to 49</option>
          <option value="zero">0 only</option>
        </select>
      </div>

      <div class="field">
        <label for="sortOrder">Sort</label>
        <select id="sortOrder">
          <option value="id_asc">ID ascending</option>
          <option value="id_desc">ID descending</option>
          <option value="points_desc">Points high to low</option>
          <option value="points_asc">Points low to high</option>
          <option value="name_asc">Name A to Z</option>
        </select>
      </div>
    </section>

    <section class="card">
      <div class="card-top">
        <div>Showing <strong id="customerCount"><%= safeCustomers.length %></strong> of <strong><%= safeCustomers.length %></strong> customers</div>
        <div>Use filters before terminating accounts</div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th></th>
              <th>Customer ID</th>
              <th>Customer</th>
              <th>Contact</th>
              <th>Points</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="customerBody">
            <tr id="emptyRow" class="<%= safeCustomers.length ? 'hidden' : '' %>">
              <td class="empty" colspan="6">No customers found.</td>
            </tr>

            <% safeCustomers.forEach(customer => { %>
              <% 
                const id = Number(customer?.id || 0);
                const username = (customer?.username || '-').toString();
                const email = (customer?.email || '-').toString();
                const contact = (customer?.contact || '-').toString();
                const points = Number(customer?.points || 0);
                const initials = username && username !== '-' ? username.trim().charAt(0) : 'U';
                const pointsBand = points >= 50 ? 'high' : (points > 0 ? 'mid' : 'zero');
                const searchData = [id, username, email, contact, points].join(' ').toLowerCase();
              %>
              <tr class="customer-row" data-search="<%= searchData %>" data-points="<%= points %>" data-id="<%= id %>" data-name="<%= username.toLowerCase() %>">
                <td><span class="avatar"><%= initials %></span></td>
                <td><span class="id-chip">#<%= id %></span></td>
                <td>
                  <div class="name"><%= username %></div>
                  <div class="email"><%= email %></div>
                </td>
                <td><%= contact %></td>
                <td><span class="points-pill <%= pointsBand %>"><%= points %></span></td>
                <td>
                  <form method="POST" action="/admin/customers/<%= id %>/delete" onsubmit="return confirm('Terminate this account? This cannot be undone.');">
                    <button class="terminate-btn" type="submit">
                      <span>X</span>
                      Terminate Account
                    </button>
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    (() => {
      const searchInput = document.getElementById('customerSearch');
      const pointsFilter = document.getElementById('pointsFilter');
      const sortOrder = document.getElementById('sortOrder');
      const countEl = document.getElementById('customerCount');
      const body = document.getElementById('customerBody');
      const emptyRow = document.getElementById('emptyRow');
      const rows = Array.from(document.querySelectorAll('.customer-row'));

      if (!rows.length) {
        if (countEl) countEl.textContent = '0';
        return;
      }

      function sortRows(list, mode) {
        const copy = list.slice();
        switch (mode) {
          case 'id_desc':
            copy.sort((a, b) => Number(b.dataset.id || 0) - Number(a.dataset.id || 0));
            break;
          case 'points_desc':
            copy.sort((a, b) => Number(b.dataset.points || 0) - Number(a.dataset.points || 0));
            break;
          case 'points_asc':
            copy.sort((a, b) => Number(a.dataset.points || 0) - Number(b.dataset.points || 0));
            break;
          case 'name_asc':
            copy.sort((a, b) => String(a.dataset.name || '').localeCompare(String(b.dataset.name || '')));
            break;
          case 'id_asc':
          default:
            copy.sort((a, b) => Number(a.dataset.id || 0) - Number(b.dataset.id || 0));
            break;
        }
        return copy;
      }

      function matchesPointsBand(row, band) {
        if (band === 'all') return true;
        const p = Number(row.dataset.points || 0);
        if (band === 'high') return p >= 50;
        if (band === 'mid') return p > 0 && p < 50;
        if (band === 'zero') return p === 0;
        return true;
      }

      function applyFilters() {
        const q = (searchInput?.value || '').trim().toLowerCase();
        const band = pointsFilter?.value || 'all';
        const sort = sortOrder?.value || 'id_asc';

        const visible = rows.filter((row) => {
          const hay = row.dataset.search || '';
          const searchOk = !q || hay.includes(q);
          if (!searchOk) return false;
          return matchesPointsBand(row, band);
        });

        rows.forEach((row) => { row.style.display = 'none'; });

        const ordered = sortRows(visible, sort);
        ordered.forEach((row) => {
          row.style.display = '';
          body.appendChild(row);
        });

        const visibleCount = ordered.length;
        if (countEl) countEl.textContent = String(visibleCount);
        if (emptyRow) emptyRow.classList.toggle('hidden', visibleCount > 0);
      }

      searchInput?.addEventListener('input', applyFilters);
      pointsFilter?.addEventListener('change', applyFilters);
      sortOrder?.addEventListener('change', applyFilters);

      applyFilters();
    })();
  </script>
</body>
</html>
