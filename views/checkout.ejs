<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>
    <%= brand || "HomeBitez" %> Checkout
  </title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@600;700;800&family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Bootstrap CSS & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <!-- PayPal SDK -->
  <script src="https://www.paypal.com/sdk/js?client-id=<%= paypalClientId %>&currency=<%= paypalCurrency %>"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #faefe5;
    }

    .hb-title {
      text-align: center;
      font-family: 'Fraunces', "Times New Roman", serif;
      font-size: 26px;
      margin-top: 10px;
      margin-bottom: 5px;
    }

    .hb-sub {
      text-align: center;
      color: #6b6b6b;
      font-size: 13px;
      margin-bottom: 6px;
    }

    .hb-underline {
      width: 70px;
      height: 3px;
      background: #dd9b00;
      margin: 0 auto 22px;
      border-radius: 99px;
    }

    .hb-wrap {
      padding: 0 40px 40px;
      max-width: 1100px;
      margin: 0 auto;
    }

    .hb-grid {
      display: grid;
      grid-template-columns: 1.45fr 1fr;
      gap: 24px;
    }

    @media (max-width:992px) {
      .hb-wrap {
        padding: 0 16px 36px;
      }

      .hb-grid {
        grid-template-columns: 1fr;
      }
    }

    .hb-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      border: 1px solid #eee;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .hb-card-title {
      font-family: 'Sniglet', system-ui, sans-serif;
      font-size: 18px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .hb-pill {
      padding: 6px 12px;
      background: #fff7e3;
      border: 1px solid #ffe2a6;
      border-radius: 999px;
      font-size: 12px;
      color: #7a5a00;
      white-space: nowrap;
    }

    .hb-summary {
      border-top: 1px solid #eee;
      margin-top: 10px;
      padding-top: 12px;
      font-size: 14px;
    }

    .hb-line {
      display: flex;
      justify-content: space-between;
      color: #5a5a5a;
      margin: 6px 0;
    }

    .hb-total {
      display: flex;
      justify-content: space-between;
      font-weight: 900;
      font-size: 18px;
    }

    .hb-total span:last-child {
      color: #dd9b00;
      font-size: 20px;
    }

    .hb-input {
      border-radius: 12px;
      border: 1px solid #eee;
      padding: 10px 12px;
      font-size: 14px;
    }

    .hb-btn {
      margin-top: 10px;
      padding: 10px 16px;
      background: #dd9b00;
      color: white;
      border: none;
      border-radius: 20px;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
      cursor: pointer;
      text-decoration: none;
    }

    .hb-btn-outline {
      background: white;
      color: #dd9b00;
      border: 1px solid #dd9b00;
    }

    #paypal-button-container {
      margin-top: 10px;
    }

    .muted-label {
      font-size: 12px;
      color: #6b6b6b;
    }

    .option-block {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border: 1px solid #f0e0bf;
      border-radius: 10px;
      margin-bottom: 10px;
    }

    .small-note {
      font-size: 12px;
      color: #5a5a5a;
      margin: 0;
    }

    .paylater-options {
      display: flex;
      gap: 10px;
    }

    .paylater-options input {
      display: none;
    }

    .paylater-option {
      flex: 1;
      border: 1px solid #eee;
      border-radius: 12px;
      padding: 12px;
      cursor: pointer;
      background: #fff;
    }

    .paylater-option strong {
      color: #2a241e;
    }

    .paylater-option small {
      color: #8a8a8a;
    }

    .paylater-options input:checked+.paylater-option {
      border-color: #dd9b00;
      background: #fff7e3;
      box-shadow: 0 0 0 2px rgba(221, 155, 0, 0.15);
    }

    .wallet-balance-note {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 700;
      color: #6b4a00;
      background: #fff6db;
      border: 1px solid #f3dfaa;
      border-radius: 999px;
      padding: 6px 10px;
    }

    .wallet-feedback {
      margin-top: 10px;
      border-radius: 10px;
      padding: 10px 12px;
      border: 1px solid #e9dcc1;
      background: #fff9ef;
      font-size: 13px;
      display: none;
    }

    .wallet-feedback.success {
      border-color: #b8dfc1;
      background: #ecf8ef;
      color: #145b23;
    }

    .wallet-feedback.error {
      border-color: #f0c2c2;
      background: #fff1f1;
      color: #7f1f1f;
    }

    .wallet-feedback.warn {
      border-color: #f1d9a3;
      background: #fff8e7;
      color: #7a5a00;
    }

    .wallet-shortage-overlay {
      position: fixed;
      inset: 0;
      background: rgba(20, 18, 14, 0.48);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 9999;
    }

    .wallet-shortage-modal {
      width: 100%;
      max-width: 420px;
      background: #fff;
      border-radius: 16px;
      border: 1px solid #ecd9b3;
      box-shadow: 0 20px 42px rgba(0, 0, 0, 0.28);
      padding: 18px;
    }

    .wallet-shortage-title {
      margin: 0;
      font-size: 20px;
      font-family: 'Sniglet', system-ui, sans-serif;
      color: #2a241e;
    }

    .wallet-shortage-sub {
      margin: 10px 0 14px;
      color: #5f5547;
      font-size: 14px;
      line-height: 1.4;
    }

    .wallet-shortage-chip {
      display: inline-block;
      background: #fff3db;
      border: 1px solid #f3dfaa;
      color: #6b4a00;
      font-weight: 800;
      border-radius: 999px;
      padding: 6px 12px;
      margin-bottom: 12px;
    }

    .wallet-shortage-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .wallet-shortage-actions .hb-btn {
      margin-top: 0;
      width: 100%;
      text-align: center;
    }
  </style>
</head>

<body>

  <%- include('partials/navbar-user') %>

    <h2 class="hb-title">Checkout</h2>
    <div class="hb-sub">No drama. Just food.</div>
    <div class="hb-underline"></div>

    <div class="hb-wrap">

      <% if (!items || items.length === 0) { %>
        <div class="hb-card">
          <div class="alert alert-warning mb-0">Your cart is empty.</div>
          <a class="hb-btn hb-btn-outline mt-3" href="/menu">
            <i class="bi bi-arrow-left"></i> Back to Menu
          </a>
        </div>
      <% } else { %>

      <div class="hb-grid">

            <!-- LEFT -->
            <div class="d-flex flex-column gap-4">

              <!-- Fulfillment -->
              <div class="hb-card">
                <div class="hb-card-title">
                  <i class="bi bi-truck"></i>
                  Fulfillment
                </div>

                <div class="option-block">
                  <input type="radio" name="mode" id="modePickup" value="pickup" <%=(prefs?.mode || 'pickup'
                    )==='pickup' ? 'checked' : '' %>>
                  <label for="modePickup" class="mb-0">
                    <strong>Pickup</strong><br>
                    <span class="small-note">Collect in store; no delivery fee.</span>
                  </label>
                </div>

                <div id="pickupFields"
                  style="display:<%= (prefs?.mode || 'pickup') === 'pickup' ? 'block' : 'none' %>;">
                  <div class="row g-2">
                    <div class="col-md-6">
                      <label class="muted-label">Pickup date</label>
                      <input class="form-control hb-input" type="date" id="pickupDate"
                        value="<%= prefs?.pickupDate || '' %>">
                    </div>
                    <div class="col-md-6">
                      <label class="muted-label">Pickup time</label>
                      <select class="form-control hb-input" id="pickupTime">
                        <option value="">Select a slot</option>
                        <option value="9-12" <%=(prefs?.pickupTime==='9-12' ) ? 'selected' : '' %>>9:00am - 12:00pm</option>
                        <option value="12-3" <%=(prefs?.pickupTime==='12-3' ) ? 'selected' : '' %>>12:00pm - 3:00pm</option>
                        <option value="3-6" <%=(prefs?.pickupTime==='3-6' ) ? 'selected' : '' %>>3:00pm - 6:00pm</option>
                        <option value="6-8" <%=(prefs?.pickupTime==='6-8' ) ? 'selected' : '' %>>6:00pm - 8:00pm</option>
                      </select>
                      <div class="text-muted" style="font-size:12px;margin-top:4px;">Choose a pickup slot; times are
                        fixed to these windows.</div>
                    </div>
                    <div class="col-12">
                      <label class="muted-label">Pickup notes (optional)</label>
                      <input class="form-control hb-input" id="pickupNotes"
                        placeholder="e.g. Call when ready, extra napkins" value="<%= prefs?.pickupNotes || '' %>">
                    </div>
                  </div>
                </div>

                <div class="option-block">
                  <input type="radio" name="mode" id="modeDelivery" value="delivery" <%=(prefs?.mode || 'pickup'
                    )==='delivery' ? 'checked' : '' %>>
                  <label for="modeDelivery" class="mb-0">
                    <strong>Delivery</strong><br>
                    <span class="small-note">Choose normal or urgent island-wide delivery.</span>
                  </label>
                </div>

                <div id="deliveryFields"
                  style="display:<%= (prefs?.mode || 'pickup') === 'delivery' ? 'block' : 'none' %>;">
                  <div class="option-block" style="margin-bottom:12px;">
                    <input type="radio" name="deliveryType" id="deliveryTypeNormal" value="normal" <%= selectedDeliveryType === 'normal' ? 'checked' : '' %>>
                    <label for="deliveryTypeNormal" class="mb-0">
                      <strong>Normal Delivery</strong><br>
                      <span class="small-note">Island-wide flat fee $<%= normalDeliveryFee.toFixed(2) %>.</span>
                    </label>
                  </div>

                  <div class="option-block" style="margin-bottom:12px;">
                    <input type="radio" name="deliveryType" id="deliveryTypeUrgent" value="urgent" <%= selectedDeliveryType === 'urgent' ? 'checked' : '' %>>
                    <label for="deliveryTypeUrgent" class="mb-0">
                      <strong>Urgent Delivery</strong><br>
                      <span class="small-note">Island-wide flat fee $<%= urgentDeliveryFee.toFixed(2) %>.</span>
                    </label>
                  </div>

                  <div class="row g-2">
                    <div class="col-md-6">
                      <label class="muted-label">Name</label>
                      <input class="form-control hb-input" id="deliveryName" placeholder="Name"
                        value="<%= prefs?.name || (user && (user.username || user.name)) || '' %>">
                    </div>
                    <div class="col-md-6">
                      <label class="muted-label">Contact</label>
                      <input class="form-control hb-input" id="deliveryContact" placeholder="Contact"
                        value="<%= prefs?.contact || '' %>">
                    </div>
                    <div class="col-12">
                      <label class="muted-label">Address</label>
                      <input class="form-control hb-input" id="deliveryAddress" placeholder="Address"
                        value="<%= prefs?.address || '' %>">
                    </div>
                    <div class="col-12">
                      <label class="muted-label">Notes (optional)</label>
                      <input class="form-control hb-input" id="deliveryNotes" placeholder="Notes"
                        value="<%= prefs?.notes || '' %>">
                    </div>
                  </div>
                </div>
              </div>

              <!-- Order Summary -->
              <div class="hb-card">
                <div class="hb-card-title">
                  <i class="bi bi-bag-heart"></i>
                  Order Summary
                  <span class="hb-pill">
                    <%= items.length %> item(s)
                  </span>
                </div>

                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>Item</th>
                        <th class="text-end">Price</th>
                        <th class="text-end">Qty</th>
                        <th class="text-end">Total</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% items.forEach(i=> { %>
                        <tr>
                          <td><strong>
                              <%= i.name %>
                            </strong></td>
                          <td class="text-end">$<%= Number(i.price).toFixed(2) %>
                          </td>
                          <td class="text-end">
                            <%= i.qty %>
                          </td>
                          <td class="text-end">$<%= Number(i.subtotal).toFixed(2) %>
                          </td>
                        </tr>
                        <% }) %>
                    </tbody>
                  </table>

                  <div class="hb-summary">
                    <div class="hb-line">
                      <span>Subtotal</span>
                      <span id="summarySubtotal">$<%= subtotal.toFixed(2) %></span>
                    </div>
                    <div class="hb-line">
                      <span>Delivery Fee</span>
                      <span id="summaryDeliveryFee">$<%= initialDeliveryFee.toFixed(2) %></span>
                    </div>
                    <% if (typeof redeem !=='undefined' && Number(redeem)> 0) { %>
                      <div class="hb-line">
                        <span>Points Applied</span>
                        <span id="summaryRedeem">- $<%= Number(redeem).toFixed(2) %></span>
                      </div>
                      <% } %>
                        <div class="hb-line">
                          <span>Fulfillment</span>
                          <span id="summaryMode">
                            <%= (prefs?.mode || 'pickup' )==='delivery' ? (selectedDeliveryType === 'urgent' ? 'Urgent Delivery' : 'Normal Delivery') : 'Pickup' %>
                          </span>
                        </div>
                        <div class="hb-line">
                          <span>Pickup slot</span>
                          <span id="summaryPickup">
                            <%= (prefs?.pickupDate || 'Set date' ) %> - <%= (prefs?.pickupTime || 'Set time' ) %>
                          </span>
                        </div>
                        <div class="hb-total">
                          <span>Total</span>
                          <span id="summaryTotal">$<%= total.toFixed(2) %></span>
                        </div>
                  </div>

                  <div class="d-flex gap-2 flex-wrap mt-3">
                    <a class="hb-btn hb-btn-outline" href="/cart"><i class="bi bi-cart3"></i> Back to Cart</a>
                    <a class="hb-btn" href="/menu"><i class="bi bi-plus-circle"></i> Add More</a>
                  </div>
              </div>

            </div>

            <!-- RIGHT -->
            <div class="d-flex flex-column gap-4">

              <!-- PAYPAL -->
              <div class="hb-card">
                <div class="hb-card-title">
                  <i class="bi bi-paypal"></i>
                  Pay with PayPal
                  <span class="hb-pill">secure</span>
                </div>

                <div id="paypal-button-container"></div>
                <div id="paypal-status" class="text-muted mt-2"></div>

                <script>
                  const checkoutItems = <%- JSON.stringify(items) %>;
                  const checkoutSubtotal = <%= subtotal.toFixed(2) %>;
                  let currentDeliveryFee = <%= initialDeliveryFee.toFixed(2) %>;

                  function renderPaypal() {
                    if (!window.paypal) {
                      document.getElementById("paypal-status").innerText =
                        "PayPal not available. Ensure PAYPAL_CLIENT_ID is set and internet is reachable.";
                      return;
                    }

                    window.paypal.Buttons({
                      createOrder: async () => {
                        if (typeof window.validateFulfillment === "function" && !window.validateFulfillment()) {
                          throw new Error("Missing fulfillment details");
                        }
                        const res = await fetch("/paypal/create-order", {
                          method: "POST",
                          credentials: "same-origin",
                          headers: { "Content-Type": "application/json" },
                          body: JSON.stringify({
                            items: checkoutItems,
                            subtotal: checkoutSubtotal,
                            deliveryFee: currentDeliveryFee
                          })
                        });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.error || "Create order failed");
                        return data.id;
                      },

                      onApprove: async (data) => {
                        const res = await fetch("/paypal/capture-order", {
                          method: "POST",
                          credentials: "same-origin",
                          headers: { "Content-Type": "application/json" },
                          body: JSON.stringify({ orderId: data.orderID })
                        });
                        const result = await res.json();
                        if (!res.ok || !result.ok) {
                          throw new Error(result.error || "Capture failed");
                        }
                        document.getElementById("paypal-status").innerText =
                          "Payment successful. Redirecting...";
                        window.location.href = "/receipt";
                      },

                      onError: (err) => {
                        console.error(err);
                        document.getElementById("paypal-status").innerText =
                          "PayPal error: " + (err.message || "Unknown error");
                      }
                    }).render("#paypal-button-container");
                  }

                  // wait for SDK load
                  if (document.readyState === "complete") renderPaypal();
                  else window.addEventListener("load", renderPaypal);
                </script>
              </div>

              <!-- WALLET -->
              <div class="hb-card">
                <div class="hb-card-title">
                  <i class="bi bi-wallet2"></i>
                  Pay with HomeBitez Wallet
                </div>

                <div class="text-muted mb-2">
                  Use your wallet to pay instantly.
                </div>

                <div class="wallet-balance-note">
                  <i class="bi bi-cash-coin"></i>
                  Balance: $<span id="walletBalanceLabel"><%= Number(walletBalance || 0).toFixed(2) %></span>
                </div>

                <button class="hb-btn w-100 mt-2" id="walletPayBtn" type="button">
                  Use Wallet
                </button>
                <div class="wallet-feedback" id="walletFeedback"></div>
              </div>


              <!-- PAYLATER -->
              <div class="hb-card">
                <div class="hb-card-title">
                  <i class="bi bi-hourglass-split"></i>
                  HomeBitez PayLater
                  <span class="hb-pill">secure</span>
                </div>

                <div class="text-muted" style="font-size:12px;">Choose a plan and pay in installments.</div>
                <form action="/paylater/choose" method="POST" class="mt-2">
                  <div class="paylater-options">
                    <input type="radio" id="paylater-3" name="months" value="3" checked>
                    <label for="paylater-3" class="paylater-option">
                      <div class="d-flex justify-content-between">
                        <div>
                          <div><strong>$<%= (total / 3).toFixed(2) %></strong></div>
                          <small>0% interest</small>
                        </div>
                        <div><strong>x 3 mth</strong></div>
                      </div>
                    </label>

                    <input type="radio" id="paylater-6" name="months" value="6">
                    <label for="paylater-6" class="paylater-option">
                      <div class="d-flex justify-content-between">
                        <div>
                          <div><strong>$<%= (total / 6).toFixed(2) %></strong></div>
                          <small>0% interest</small>
                        </div>
                        <div><strong>x 6 mth</strong></div>
                      </div>
                    </label>
                  </div>
                  <button type="submit" class="hb-btn w-100 mt-3">Buy Now</button>
                </form>
                <div class="text-muted mt-2" style="font-size:12px;">0% interest. Credit limit applies.</div>
              </div>
              <% if (typeof paylaterError !=="undefined" && paylaterError) { %>
                <div class="hb-card">
                  <div class="alert alert-warning mb-0">
                    <%= paylaterError %>
                  </div>
                </div>
                <% } %>
                  <!-- STRIPE CARD PAYMENT -->
                  <div class="hb-card">
                    <div class="hb-card-title">
                      <i class="bi bi-credit-card-2-front"></i>
                      Pay with Stripe
                      <span class="hb-pill">secure</span>
                    </div>

                    <div class="text-muted" style="font-size:12px;">
                      Secure credit / debit card payment.
                    </div>

                    <button id="stripeBtn" class="hb-btn w-100 mt-2">
                      <i class="bi bi-credit-card"></i> Stripe
                    </button>
                  </div>

            </div>

          </div>
          <% } %>

    </div>

    <div class="wallet-shortage-overlay" id="walletShortageOverlay">
      <div class="wallet-shortage-modal">
        <h3 class="wallet-shortage-title">Insufficient Wallet Balance</h3>
        <p class="wallet-shortage-sub">
          You do not have enough funds for this order. Top up your wallet to continue checkout.
        </p>
        <div class="wallet-shortage-chip">
          Top up needed: $<span id="walletTopupNeeded">0.00</span>
        </div>
        <div class="wallet-shortage-actions">
          <a id="walletTopupLink" class="hb-btn" href="/digitalwallet?redirect=/checkout">Top Up Wallet</a>
          <button id="walletShortageCloseBtn" class="hb-btn hb-btn-outline" type="button">Choose Another</button>
        </div>
      </div>
    </div>

    <script>
      // Fulfillment controls
      const modePickup = document.getElementById("modePickup");
      const modeDelivery = document.getElementById("modeDelivery");
      const pickupFields = document.getElementById("pickupFields");
      const deliveryFields = document.getElementById("deliveryFields");
      const pickupDate = document.getElementById("pickupDate");
      const pickupTime = document.getElementById("pickupTime");
      const deliveryName = document.getElementById("deliveryName");
      const deliveryContact = document.getElementById("deliveryContact");
      const deliveryAddress = document.getElementById("deliveryAddress");
      const deliveryNotes = document.getElementById("deliveryNotes");
      const deliveryTypeNormal = document.getElementById("deliveryTypeNormal");
      const deliveryTypeUrgent = document.getElementById("deliveryTypeUrgent");

      const summaryDeliveryFee = document.getElementById("summaryDeliveryFee");
      const summaryTotal = document.getElementById("summaryTotal");
      const summaryMode = document.getElementById("summaryMode");
      const summaryPickup = document.getElementById("summaryPickup");
      const walletPayBtn = document.getElementById("walletPayBtn");
      const walletBalanceLabel = document.getElementById("walletBalanceLabel");
      const walletFeedback = document.getElementById("walletFeedback");
      const walletShortageOverlay = document.getElementById("walletShortageOverlay");
      const walletTopupNeeded = document.getElementById("walletTopupNeeded");
      const walletTopupLink = document.getElementById("walletTopupLink");
      const walletShortageCloseBtn = document.getElementById("walletShortageCloseBtn");

      const subtotalValue = Number(<%= subtotal.toFixed(2) %>);
      const normalDeliveryFeeNum = Number(<%= normalDeliveryFee.toFixed(2) %>);
      const urgentDeliveryFeeNum = Number(<%= urgentDeliveryFee.toFixed(2) %>);
      let currentDeliveryFeeNum = Number(<%= initialDeliveryFee.toFixed(2) %>);
      const redeemAmount = Number(<%=(redeem || 0).toFixed(2) %>);

      function getSelectedDeliveryType() {
        return deliveryTypeUrgent && deliveryTypeUrgent.checked ? "urgent" : "normal";
      }

      // Enforce pickup date between today and +2 months
      if (pickupDate) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const maxDate = new Date(today);
        maxDate.setMonth(maxDate.getMonth() + 2);

        const minDateStr = today.toISOString().split("T")[0];
        const maxDateStr = maxDate.toISOString().split("T")[0];
        pickupDate.setAttribute("min", minDateStr);
        pickupDate.setAttribute("max", maxDateStr);

        pickupDate.addEventListener("change", () => {
          if (!pickupDate.value) return;
          if (pickupDate.value < minDateStr || pickupDate.value > maxDateStr) {
            alert(`Please choose a date between ${minDateStr} and ${maxDateStr}.`);
            pickupDate.value = "";
          }
        });
      }

      function computeTotal() {
        return Number((subtotalValue + currentDeliveryFeeNum - redeemAmount).toFixed(2));
      }

      function hideWalletShortage() {
        if (walletShortageOverlay) walletShortageOverlay.style.display = "none";
      }

      function showWalletShortage(neededAmount) {
        const needed = Number(neededAmount || 0);
        if (walletTopupNeeded) walletTopupNeeded.textContent = needed.toFixed(2);
        if (walletTopupLink) {
          walletTopupLink.href = `/digitalwallet?redirect=/checkout&topup=${encodeURIComponent(needed.toFixed(2))}`;
        }
        if (walletShortageOverlay) walletShortageOverlay.style.display = "flex";
      }

      function showWalletFeedback(type, message) {
        if (!walletFeedback) return;
        walletFeedback.className = `wallet-feedback ${type || ""}`.trim();
        walletFeedback.textContent = message;
        walletFeedback.style.display = message ? "block" : "none";
      }

      async function useWallet() {
        if (typeof window.validateFulfillment === "function" && !window.validateFulfillment()) {
          return;
        }

        const total = computeTotal();
        if (!Number.isFinite(total) || total <= 0) {
          showWalletFeedback("error", "Invalid total amount. Please refresh and try again.");
          return;
        }

        if (walletPayBtn) {
          walletPayBtn.disabled = true;
          walletPayBtn.textContent = "Processing...";
        }
        showWalletFeedback("", "");

        try {
          const res = await fetch("/digitalwallet/use", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ total })
          });
          const data = await res.json();

          if (data.success) {
            const newBalance = Number(data.newBalance || 0);
            if (walletBalanceLabel) walletBalanceLabel.textContent = newBalance.toFixed(2);
            showWalletFeedback("success", `Payment successful. New balance: $${newBalance.toFixed(2)}. Redirecting...`);
            setTimeout(() => { window.location.href = "/receipt"; }, 800);
            return;
          }

          if (data.needed) {
            const neededNum = Number(data.needed || 0);
            showWalletFeedback("warn", `You need $${neededNum.toFixed(2)} more in your wallet.`);
            showWalletShortage(neededNum);
            return;
          }

          if (data.error && data.error.includes("Daily wallet spend limit")) {
            showWalletFeedback("warn", "Daily wallet spend limit reached. Please use another payment method.");
            return;
          }

          showWalletFeedback("error", data.error || "Wallet payment failed.");
        } catch (err) {
          console.error(err);
          showWalletFeedback("error", "An error occurred while paying with wallet. Please try again.");
        } finally {
          if (walletPayBtn) {
            walletPayBtn.disabled = false;
            walletPayBtn.textContent = "Use Wallet";
          }
        }
      }

      function validateFulfillment(showAlerts = true) {
        const errs = [];
        if (modePickup && modePickup.checked) {
          if (!pickupDate || !pickupDate.value) errs.push("Select a pickup date.");
          if (!pickupTime || !pickupTime.value) errs.push("Choose a pickup slot.");
        } else if (modeDelivery && modeDelivery.checked) {
          if (!deliveryName || !deliveryName.value.trim()) errs.push("Enter the delivery name.");
          if (!deliveryContact || !deliveryContact.value.trim()) errs.push("Enter a delivery contact number.");
          if (!deliveryAddress || !deliveryAddress.value.trim()) errs.push("Enter the delivery address.");
        }

        if (errs.length && showAlerts) {
          alert("Please finish these before checking out:\n- " + errs.join("\n- "));
          return false;
        }
        return true;
      }

      function syncSummary() {
        summaryDeliveryFee.textContent = `$${currentDeliveryFeeNum.toFixed(2)}`;
        summaryMode.textContent = modeDelivery.checked
          ? (getSelectedDeliveryType() === "urgent" ? "Urgent Delivery" : "Normal Delivery")
          : "Pickup";
        summaryPickup.textContent = modePickup.checked
          ? `${pickupDate.value || "Set date"} - ${pickupTime.value || "Set time"}`
          : "N/A";
        summaryTotal.textContent = `$${computeTotal().toFixed(2)}`;
        // Update PayPal variable used inside createOrder closure
        if (typeof currentDeliveryFee !== "undefined") {
          currentDeliveryFee = Number(currentDeliveryFeeNum.toFixed(2));
        }
      }

      function savePrefs() {
        const payload = {
          mode: modeDelivery.checked ? "delivery" : "pickup",
          deliveryType: getSelectedDeliveryType(),
          pickupDate: pickupDate ? pickupDate.value : "",
          pickupTime: pickupTime ? pickupTime.value : "",
          name: deliveryName ? deliveryName.value : "",
          address: deliveryAddress ? deliveryAddress.value : "",
          contact: deliveryContact ? deliveryContact.value : "",
          notes: deliveryNotes ? deliveryNotes.value : ""
        };

        fetch("/cart/preferences", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        }).catch(() => { });
      }

      function handleModeChange() {
        if (modeDelivery.checked) {
          pickupFields.style.display = "none";
          deliveryFields.style.display = "block";
          currentDeliveryFeeNum = getSelectedDeliveryType() === "urgent" ? urgentDeliveryFeeNum : normalDeliveryFeeNum;
          [deliveryName, deliveryContact, deliveryAddress].forEach(el => { if (el) el.required = true; });
          if (pickupDate) pickupDate.required = false;
          if (pickupTime) pickupTime.required = false;
        } else {
          pickupFields.style.display = "block";
          deliveryFields.style.display = "none";
          currentDeliveryFeeNum = 0;
          [deliveryName, deliveryContact, deliveryAddress].forEach(el => { if (el) el.required = false; });
          if (pickupDate) pickupDate.required = true;
          if (pickupTime) pickupTime.required = true;
        }
        syncSummary();
        savePrefs();
      }

      if (modePickup) modePickup.addEventListener("change", handleModeChange);
      if (modeDelivery) modeDelivery.addEventListener("change", handleModeChange);

      if (pickupDate) pickupDate.addEventListener("change", () => { syncSummary(); savePrefs(); });
      if (pickupTime) pickupTime.addEventListener("change", () => { syncSummary(); savePrefs(); });
      if (deliveryTypeNormal) deliveryTypeNormal.addEventListener("change", () => {
        if (modeDelivery && modeDelivery.checked) {
          currentDeliveryFeeNum = normalDeliveryFeeNum;
          syncSummary();
        }
        savePrefs();
      });
      if (deliveryTypeUrgent) deliveryTypeUrgent.addEventListener("change", () => {
        if (modeDelivery && modeDelivery.checked) {
          currentDeliveryFeeNum = urgentDeliveryFeeNum;
          syncSummary();
        }
        savePrefs();
      });
      if (deliveryName) deliveryName.addEventListener("change", savePrefs);
      if (deliveryContact) deliveryContact.addEventListener("change", savePrefs);
      if (deliveryAddress) deliveryAddress.addEventListener("change", savePrefs);
      if (deliveryNotes) deliveryNotes.addEventListener("change", savePrefs);

      handleModeChange();
      syncSummary();

      const paylaterForm = document.querySelector("form[action='/paylater/choose']");
      if (paylaterForm) {
        paylaterForm.addEventListener("submit", (e) => {
          if (!validateFulfillment()) e.preventDefault();
        });
      }

      if (walletPayBtn) walletPayBtn.addEventListener("click", useWallet);
      if (walletShortageCloseBtn) walletShortageCloseBtn.addEventListener("click", hideWalletShortage);
      if (walletShortageOverlay) {
        walletShortageOverlay.addEventListener("click", (e) => {
          if (e.target === walletShortageOverlay) hideWalletShortage();
        });
      }

      window.validateFulfillment = validateFulfillment;
    </script>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
      const stripe = Stripe('<%= process.env.STRIPE_PUBLISHABLE_KEY %>');

      const stripeBtn = document.getElementById('stripeBtn');

      if (stripeBtn) {
        stripeBtn.addEventListener('click', async () => {

          // Validate pickup/delivery first
          if (typeof window.validateFulfillment === "function" && !window.validateFulfillment()) {
            return;
          }

          const res = await fetch('/stripe/create-checkout-session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              subtotal: <%= subtotal.toFixed(2) %>,
              deliveryFee: currentDeliveryFeeNum
            })
          });

          const data = await res.json();

          if (data.id) {
            stripe.redirectToCheckout({ sessionId: data.id });
          } else {
            alert('Stripe payment failed.');
          }
        });
      }
    </script>

</body>

</html>
