<%- include('../partials/head', { title: 'Order Details' }) %>
<%- include('../partials/navbar-bizowner') %>

<style>
  body { background:#faefe5; color:#2a241e; }
  .wrap { max-width: 1050px; margin:26px auto 60px; padding:0 18px; }
  .card { background:#fffefb; border:1px solid #ecdcb8; border-radius:14px; box-shadow:0 10px 26px rgba(0,0,0,0.05); padding:18px 20px; }
  .header { display:grid; grid-template-columns:1.2fr 1fr; gap:12px; align-items:flex-start; }
  .title { font-size:22px; font-weight:900; margin:0 0 10px; }
  .muted { color:#6b5d4a; font-size:13px; }
  .section { border:1px solid #f1dfbb; border-radius:10px; padding:12px 14px; background:#fff; margin-top:12px; }
  .section-title { font-weight:800; margin:0 0 6px; display:flex; align-items:center; gap:8px; }
  .grid-2 { display:grid; grid-template-columns:1.2fr 1fr; gap:14px; }
  table { width:100%; border-collapse:collapse; }
  thead th { background:#f7eedf; padding:12px 10px; font-weight:800; border-color:#f1dfbb; }
  tbody td { padding:12px 10px; border-color:#f1dfbb; }
  .summary-line { display:flex; justify-content:space-between; margin:6px 0; font-weight:700; }
  .summary-total { font-size:20px; color:#dd9b00; font-weight:900; }
  .btn-row { display:flex; justify-content:flex-end; gap:10px; margin-top:16px; flex-wrap:wrap; }
  .btn-hb { border:1px solid #dd9b00; color:#dd9b00; border-radius:10px; padding:10px 14px; font-weight:700; text-decoration:none; }
  .btn-hb.primary { background:#dd9b00; color:white; }
  .status-pill{
    display:inline-flex; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700; text-transform:capitalize;
  }
  .paid{ background:#e6f6e9; color:#1b7a2e; }
  .pending{ background:#fff4dc; color:#8c6a00; }
  .completed{ background:#e9e7ff; color:#3f3ba6; }
  .table-items th, .table-items td{ text-align:center; vertical-align:middle; }
  .charge-summary{
    border:1px solid #f1dfbb;
    border-radius:10px;
    padding:10px 12px;
    background:#fff;
    display:flex;
    gap:16px;
    justify-content:space-between;
    flex-wrap:wrap;
    margin-top:8px;
  }
  .charge-col{
    flex:1 1 160px;
  }
  .charge-line{
    display:flex;
    justify-content:space-between;
    margin:4px 0;
    font-weight:700;
  }
</style>

<div class="wrap">
  <h2 class="title">Order Details</h2>
  <div class="card">

    <div class="header">
      <div>
        <div class="muted">Order #</div>
        <div style="font-weight:800; font-size:18px;"><%= order.paypal_order_id || ('ORD-' + order.id) %></div>
        <div class="muted" style="margin-top:4px;"><%= order.created_at ? new Date(order.created_at).toLocaleString() : '' %></div>
      </div>
      <div style="text-align:right;">
        <div class="muted">Payer</div>
        <div style="font-weight:700;"><%= order.payer_email || '-' %></div>
        <div style="margin-top:8px;">
          <% const statusKey = (order.fulfillmentStatus || '').toLowerCase(); %>
          <span class="status-pill <%= statusKey === 'completed' ? 'completed' : (statusKey === 'paid' ? 'paid' : 'pending') %>">
            <%= statusKey === 'completed' ? 'Completed' : (statusKey === 'paid' ? 'Paid' : 'Pending') %>
          </span>
          <% if (order.completedAt || order.completed_at) { %>
            <div class="muted" style="margin-top:4px;">Completed at: <%= order.completedAt || order.completed_at %></div>
          <% } %>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="grid-2" style="align-items:flex-start;">
        <div>
          <div class="muted">Payment Method</div>
          <div style="font-weight:700;"><%= order.paymentMethod %></div>
          <div class="muted" style="margin-top:6px;">Payment Ref: <%= order.paymentRef || '-' %></div>
          <div class="muted">Txn / Capture ID: <%= order.paymentCapture || '-' %></div>
        </div>
        <div style="text-align:right;">
          <div class="muted">Total</div>
          <div class="summary-total">$<%= Number(order.total||0).toFixed(2) %></div>
        </div>
      </div>
      <div class="charge-summary">
        <div class="charge-col">
          <div class="muted">Fulfillment</div>
          <div style="font-weight:700;"><%= order.fulfillmentMode || 'Pickup' %></div>
        </div>
        <div class="charge-col">
          <div class="charge-line"><span>Subtotal</span><span>$<%= Number(order.subtotal||0).toFixed(2) %></span></div>
          <div class="charge-line"><span>Delivery / Pickup</span><span>$<%= Number(order.deliveryFee||0).toFixed(2) %></span></div>
          <div class="charge-line"><span>Total</span><span>$<%= Number(order.total||0).toFixed(2) %></span></div>
        </div>
      </div>
    </div>

    <div class="section" style="margin-top:14px;">
      <div class="section-title"><i class="bi bi-list-ul"></i> Items</div>
      <div class="table-responsive">
        <table class="table align-middle table-items">
          <thead>
            <tr>
              <th>Item</th>
              <th>Price</th>
              <th>Qty</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            <% (order.items || []).forEach(i => { %>
              <tr>
                <td><%= i.name %></td>
                <td>$<%= Number(i.price||0).toFixed(2) %></td>
                <td><%= Number(i.qty||0) %></td>
                <td>$<%= Number((i.price||0)*(i.qty||0)).toFixed(2) %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>

    <div class="btn-row">
      <a class="btn-hb" href="/bizowner/orders">Back</a>
      <a class="btn-hb" href="/bizowner">Dashboard</a>
      <% if ((order.fulfillmentStatus || '').toLowerCase() !== 'completed') { %>
        <form action="/bizowner/orders/<%= order.id %>/complete" method="POST" onsubmit="return confirm('Mark this order as completed?');">
          <button type="submit" class="btn-hb primary">Mark Completed</button>
        </form>
      <% } %>
    </div>

  </div>
</div>
