<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%= brand || "HomeBitez" %> Receipt</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <style>
    :root {
      --accent: #dd9b00;
      --accent-dark: #c08400;
      --muted: #6b5d4a;
      --bg: #faefe5;
      --card: #fffdf8;
      --border: #f1dfbb;
    }

    body {
      background: var(--bg);
      font-family: 'Segoe UI', Arial, sans-serif;
      color: #2f2a24;
    }

    .receipt-wrap {
      max-width: 1080px;
      margin: 24px auto 60px;
      padding: 0 20px 20px;
    }

    .receipt-card {
      background: var(--card);
      border-radius: 14px;
      padding: 24px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.08);
      border: 1px solid var(--border);
    }

    .receipt-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 14px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-logo {
      width: 58px;
      height: 58px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--accent), #ffc446);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #2f2a24;
      font-weight: 900;
      font-size: 18px;
    }

    .brand-title {
      font-size: 22px;
      font-weight: 900;
    }

    .status-flow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .status-step{
      padding:6px 10px;
      border:1px solid var(--border);
      border-radius:10px;
      font-size:12px;
      background:#fff;
      color:#2f2a24;
    }
    .status-step.done{
      background:#fce7b3;
      border-color:#f1d48a;
      font-weight:700;
    }

    .meta {
      text-align: right;
      font-size: 13px;
      color: var(--muted);
      min-width: 220px;
    }

    .meta strong {
      color: #1f1a14;
    }

    .section-card {
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 14px 16px;
      background: #fff;
    }

    .section-title {
      font-weight: 800;
      margin-bottom: 8px;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .pill {
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      background:#fff4dc;
      border:1px solid var(--border);
      border-radius:999px;
      font-size:12px;
      color:#2f2a24;
      margin-top:8px;
    }

    .items-table thead th {
      border-bottom: 1px solid var(--border);
      font-weight: 700;
      color:#433d33;
    }

    .items-table tbody td {
      border-color: var(--border);
    }

    .totals {
      min-width: 260px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      padding:14px 16px;
    }

    .totals .line {
      display: flex;
      justify-content: space-between;
      margin: 6px 0;
      color: #444;
      font-weight:600;
    }

    .totals .total-amount {
      font-size: 22px;
      font-weight: 900;
      color: var(--accent);
    }

    .actions {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      flex-wrap:wrap;
    }

    .btn-hb{
      border-radius:10px;
      border:1px solid var(--accent);
      padding:10px 14px;
      font-weight:700;
      display:inline-flex;
      align-items:center;
      gap:6px;
      text-decoration:none;
      color:var(--accent);
      background:white;
    }
    .btn-hb.primary{
      background:var(--accent);
      color:white;
    }

    @media print {
      body { background: white; }
      .actions, .navbar { display: none !important; }
      .receipt-card { box-shadow: none; border: none; }
    }
  </style>
</head>

<body>

  <%- include('partials/navbar-user') %>

  <div class="receipt-wrap">
    <div class="receipt-card">

      <!-- HEADER -->
      <div class="receipt-header">
        <div class="brand">
          <div class="brand-logo">HB</div>
          <div>
            <div class="brand-title">HomeBitez</div>
            <div class="text-muted">Payment Receipt</div>
            <div class="status-flow">
              <div class="status-step done">pending</div>
              <div class="status-step <%= isPaid ? 'done' : '' %>">paid</div>
              <div class="status-step <%= isPaid ? 'done' : '' %>">fulfilled</div>
            </div>
          </div>
        </div>

        <div class="meta">
          <div><strong>Receipt</strong></div>
          <div>Order #: <strong><%= latestOrderDbId || 'N/A' %></strong></div>
          <div>Payment: <strong><%= paymentMethod %></strong></div>
          <div>Payment Ref: <strong><%= paymentMeta?.refId || '-' %></strong></div>
          <div>Txn ID: <strong><%= paymentMeta?.txnId || '-' %></strong></div>
          <div class="text-muted" style="margin-top:6px;">
            Issued: <%= new Date().toLocaleString() %>
          </div>
        </div>
      </div>

      <!-- INFO BLOCKS -->
      <div class="row g-3 mt-3">
        <div class="col-md-6">
          <div class="section-card">
            <div class="section-title"><i class="bi bi-person-circle"></i> Bill to</div>
            <div style="font-weight:800;"><%= (user && (user.username || user.name)) || 'Guest' %></div>
            <div class="text-muted" style="font-size:13px;">
              <%= paymentMeta && paymentMeta.payerEmail ? paymentMeta.payerEmail : (user?.email || 'Email not provided') %>
            </div>
            <div class="pill">Payment: <%= paymentMethod %></div>
            <% if (paymentMethod === 'PayLater' && paylaterPlan) { %>
              <div class="pill">Plan: <%= paylaterPlan.months %> months · $<%= Number(paylaterPlan.monthly || 0).toFixed(2) %>/mo</div>
            <% } %>
          </div>
        </div>
        <div class="col-md-6">
          <div class="section-card">
            <div class="section-title"><i class="bi bi-geo-alt"></i> Fulfillment</div>
            <div style="font-weight:800; text-transform:capitalize;"><%= fulfillment %></div>
            <div class="text-muted" style="font-size:13px;">
              Delivery fee: $<%= Number(deliveryFee || 0).toFixed(2) %>
            </div>
            <% if (fulfillment === 'Pickup') { %>
              <div class="text-muted" style="font-size:13px;">Pickup slot: <%= (prefs?.pickupDate || 'Set date') %> · <%= (prefs?.pickupTime || 'Set time') %></div>
              <div class="pill">Status: Ready for pickup</div>
            <% } else { %>
              <div style="font-size:13px; margin-top:6px;">
                <div><strong>Address:</strong> <%= prefs?.address || 'Not provided' %></div>
                <div><strong>Contact:</strong> <%= prefs?.contact || 'Not provided' %></div>
                <div><strong>Notes:</strong> <%= prefs?.notes || '—' %></div>
              </div>
            <% } %>
          </div>
        </div>
      </div>

      <!-- ITEMS -->
      <div class="row mt-3">
        <div class="col-md-8">
          <div class="table-responsive">
            <table class="table items-table">
              <thead>
                <tr>
                  <th>Item</th>
                  <th class="text-end">Price</th>
                  <th class="text-end">Qty</th>
                  <th class="text-end">Total</th>
                </tr>
              </thead>
              <tbody>
                <% items.forEach(i => { %>
                  <tr>
                    <td><%= i.name %></td>
                    <td class="text-end">$<%= Number(i.price || 0).toFixed(2) %></td>
                    <td class="text-end"><%= Number(i.qty || 0) %></td>
                    <td class="text-end">$<%= Number(i.subtotal || 0).toFixed(2) %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
          <div class="section-card mt-2">
            <div class="section-title"><i class="bi bi-card-text"></i> Notes</div>
            <div class="text-muted" style="font-size:13px;">
              Thank you for dining with us. This receipt serves as proof of payment.
              For changes, contact support within 1 hour of order.
            </div>
          </div>
        </div>

        <!-- TOTALS -->
        <div class="col-md-4 d-flex justify-content-end">
          <div class="totals">
            <div class="line">
              <span>Subtotal</span>
              <span>$<%= Number(subtotal || 0).toFixed(2) %></span>
            </div>
            <div class="line">
              <span>Delivery fee</span>
              <span>$<%= Number(deliveryFee || 0).toFixed(2) %></span>
            </div>
            <hr />
            <div class="line">
              <span><%= paymentMethod === 'PayLater' ? 'Total due' : 'Total paid' %></span>
              <span class="total-amount">$<%= Number(total || 0).toFixed(2) %></span>
            </div>
            <% if (paymentMethod === 'PayLater' && paylaterPlan) { %>
              <div class="line" style="font-size:12px;color:#6b5d4a;">
                <span>Installment</span>
                <span>$<%= Number(paylaterPlan.monthly || 0).toFixed(2) %> / month</span>
              </div>
            <% } %>
          </div>
        </div>
      </div>

      <!-- ACTIONS -->
      <div class="actions">
        <a class="btn-hb" href="/menu"><i class="bi bi-arrow-left"></i> Back to Menu</a>
        <a class="btn-hb" href="/"><i class="bi bi-house"></i> Home</a>
        <button class="btn-hb primary ms-auto" onclick="window.print()">
          <i class="bi bi-printer"></i> Print / Save PDF
        </button>
      </div>

    </div>
  </div>

</body>
</html>
