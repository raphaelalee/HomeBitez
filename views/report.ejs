<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Report an Issue - HomeBitez</title>

<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Sniglet:wght@700;900&display=swap" rel="stylesheet">

<!-- Bootstrap CSS & Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<style>
body {
    background: #faefe5;
    font-family: Arial, sans-serif;
}

/* FORM CARD */
.form-card {
    background: white;
    max-width: 700px;
    margin: 30px auto 60px;
    padding: 30px;
    border-radius: 14px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
}

.report-list {
    max-width: 700px;
    margin: 0 auto 60px;
    display: grid;
    gap: 16px;
}

.report-item {
    background: white;
    border-radius: 14px;
    padding: 20px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
}

.report-item h5 {
    font-size: 16px;
    margin-bottom: 6px;
}

.report-item .meta {
    font-size: 12px;
    color: #7a6e63;
    margin-bottom: 10px;
}

.reply-box {
    background: #f6f6f6;
    border-radius: 10px;
    padding: 12px 14px;
    margin-top: 10px;
    font-size: 13px;
}

.user-reply {
    background: #fff3d6;
    border-radius: 10px;
    padding: 12px 14px;
    margin-top: 10px;
    font-size: 13px;
}

.reply-form textarea {
    width: 100%;
    border-radius: 10px;
    border: 1px solid #e0d4c8;
    padding: 10px 12px;
    font-size: 13px;
}

.reply-btn {
    background: #dd9b00;
    border: none;
    color: #fff;
    padding: 6px 14px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
}

.resolve-btn {
    background: #dd9b00;
    border: none;
    color: #fff;
    padding: 6px 14px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
}

/* BUTTON */
.btn-submit {
    background: #dd9b00;
    color: white;
    border: none;
}
</style>
</head>
<body>

<!-- INCLUDE NAVBAR -->
<%- include('partials/navbar-user') %>

<div class="form-card">
    <h3 class="mb-3">Report an Issue</h3>
    <p class="text-muted">Tell us what went wrong so we can fix it quickly.</p>

    <% if (error && error.length) { %>
        <div class="alert alert-danger"><%= error %></div>
    <% } %>
    <% if (success && success.length) { %>
        <div class="alert alert-success"><%= success %></div>
    <% } %>

    <form action="/report" method="POST" class="row g-3">
        <div class="col-md-6">
            <label class="form-label">Name</label>
            <input type="text" name="name" class="form-control" required>
        </div>
        <div class="col-md-6">
            <label class="form-label">Email</label>
            <input type="email" name="email" class="form-control" value="<%= userEmail || '' %>" readonly>
        </div>
        <div class="col-12">
            <label class="form-label">Subject</label>
            <input type="text" name="subject" class="form-control" required>
        </div>
        <div class="col-12">
            <label class="form-label">Description</label>
            <textarea name="description" rows="5" class="form-control" placeholder="Describe the issue in detail..." required></textarea>
        </div>
        <div class="col-12 text-end">
            <button type="submit" class="btn btn-submit px-4">Submit Report</button>
        </div>
    </form>
</div>

<% if (issues && issues.length) { %>
    <div class="report-list">
        <% issues.forEach(issue => { %>
            <div class="report-item">
                <h5><%= issue.subject %></h5>
                <div class="meta">
                    <span><%= issue.created_at ? new Date(issue.created_at).toLocaleDateString("en-GB") : "" %></span>
                    <span class="ms-2">Status: <%= issue.status || 'new' %></span>
                </div>
                <div><%= issue.description %></div>
                <% if (issue.admin_reply) { %>
                    <div class="reply-box">
                        <strong>Admin reply:</strong>
                        <div><%= issue.admin_reply %></div>
                    </div>
                <% } %>
                <% if (issue.user_reply) { %>
                    <div class="user-reply">
                        <strong>Your reply:</strong>
                        <div><%= issue.user_reply %></div>
                    </div>
                <% } %>
                <% if (issue.admin_reply && (issue.status || '').toLowerCase() !== 'resolved') { %>
                    <form method="POST" action="/report/<%= issue.id %>/reply" class="reply-form mt-3">
                        <textarea name="reply" rows="3" placeholder="Reply to admin..." required></textarea>
                        <div class="mt-2">
                            <button type="submit" class="reply-btn">Send Reply</button>
                        </div>
                    </form>
                <% } %>
                <% if ((issue.status || '').toLowerCase() !== 'resolved') { %>
                    <form method="POST" action="/report/<%= issue.id %>/resolve" class="mt-3">
                        <button type="submit" class="resolve-btn">Mark as Resolved</button>
                    </form>
                <% } %>
            </div>
        <% }) %>
    </div>
<% } %>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

